name: Auto Approve

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-approve:
    name: Auto Approve PR
    runs-on: ubuntu-latest

    # Auto-approve 조건:
    # 1. PR 작성자가 허용된 사용자 목록에 있음
    # 2. CI가 통과함
    # 주의: 나중에 팀원이 늘어나면 이 워크플로우를 비활성화하거나 조건을 강화하세요

    if: |
      github.event.pull_request.user.login == 'Hulkong' ||
      github.event.pull_request.user.login == 'yonghyun-kim'

    steps:
      - name: Wait for CI
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-for-ci
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Lint and Validate
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 300
          intervalSeconds: 10

      - name: Auto Approve
        if: steps.wait-for-ci.outputs.conclusion == 'success'
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          review-message: |
            ✅ Auto-approved by CI pipeline

            **Approval Criteria Met:**
            - PR author: `${{ github.event.pull_request.user.login }}` (trusted contributor)
            - CI Status: Passed ✅

            ---
            *This is an automated approval. Please ensure all changes are reviewed before merging.*

      - name: Enable Auto-merge
        if: steps.wait-for-ci.outputs.conclusion == 'success'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash

      - name: Add Labels
        if: steps.wait-for-ci.outputs.conclusion == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['auto-approved', 'ready-to-merge']
            });

      - name: CI Failed - Request Review
        if: steps.wait-for-ci.outputs.conclusion != 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `⚠️ **Auto-approval blocked**

              CI checks did not pass. Please review and fix the issues.

              **CI Status:** ${{ steps.wait-for-ci.outputs.conclusion }}

              Once CI passes, auto-approval will be triggered automatically.`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['needs-review', 'ci-failed']
            });

name: Project Management

on:
  issues:
    types: [opened, reopened, closed, labeled]
  pull_request:
    types: [opened, reopened, closed, labeled]
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write

jobs:
  auto-label:
    name: Auto Label
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.issue?.title || context.payload.pull_request?.title;
            const labels = [];

            // Type labels
            if (title.toLowerCase().includes('bug') || title.toLowerCase().includes('fix')) labels.push('bug');
            if (title.toLowerCase().includes('feature') || title.toLowerCase().includes('add')) labels.push('feature');
            if (title.toLowerCase().includes('security')) labels.push('security');
            if (title.toLowerCase().includes('enhance')) labels.push('enhancement');
            if (title.toLowerCase().includes('docs')) labels.push('documentation');
            if (title.toLowerCase().includes('refactor')) labels.push('refactor');
            if (title.toLowerCase().includes('chore')) labels.push('chore');

            // Component labels
            if (title.toLowerCase().includes('gitops') || title.toLowerCase().includes('argocd')) labels.push('gitops');
            if (title.toLowerCase().includes('terraform') || title.toLowerCase().includes('infra')) labels.push('infrastructure');
            if (title.toLowerCase().includes('helm') || title.toLowerCase().includes('chart')) labels.push('helm');
            if (title.toLowerCase().includes('ci') || title.toLowerCase().includes('workflow')) labels.push('ci/cd');

            // Priority labels
            if (title.toLowerCase().includes('urgent') || title.toLowerCase().includes('critical')) {
              labels.push('priority: high');
            } else if (title.toLowerCase().includes('minor') || title.toLowerCase().includes('low')) {
              labels.push('priority: low');
            } else {
              labels.push('priority: medium');
            }

            if (labels.length > 0) {
              const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: labels
              });
            }

  auto-assign:
    name: Auto Assign
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            if (issueNumber) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                assignees: [context.actor]
              });
            }

  stale-management:
    name: Stale Issue Management
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/stale@v9
        with:
          stale-issue-message: |
            This issue has been automatically marked as stale because it has not had
            recent activity. It will be closed if no further activity occurs.
          stale-pr-message: |
            This PR has been automatically marked as stale because it has not had
            recent activity. It will be closed if no further activity occurs.
          stale-issue-label: "stale"
          stale-pr-label: "stale"
          days-before-stale: 30
          days-before-close: 7

name: Claude AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files_ignore: |
            **/*.md
            **/*.txt
            .gitignore
            .github/**

      - name: Prepare Review Context
        id: context
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## Changed Files" > review_context.md
          echo "" >> review_context.md

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [ -f "$file" ]; then
              echo "### $file" >> review_context.md
              echo '```' >> review_context.md
              head -200 "$file" >> review_context.md
              echo '```' >> review_context.md
              echo "" >> review_context.md
            fi
          done

          # Get PR description
          echo "## PR Description" >> review_context.md
          echo "${{ github.event.pull_request.body }}" >> review_context.md

      - name: Claude AI Review
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: anthropics/anthropic-sdk-python@main
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        id: claude
        run: |
          # Claude APIë¥¼ í†µí•œ ì½”ë“œ ë¦¬ë·° (API í‚¤ê°€ ìžˆëŠ” ê²½ìš°ì—ë§Œ ë™ìž‘)
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "âš ï¸ ANTHROPIC_API_KEY not set, skipping AI review"
            echo "review_available=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          pip install anthropic

          python3 << 'EOF'
          import anthropic
          import os

          client = anthropic.Anthropic()

          with open('review_context.md', 'r') as f:
              context = f.read()

          prompt = f"""You are a senior DevOps engineer reviewing infrastructure code changes.
          Review the following changes and provide:
          1. **Summary**: Brief summary of changes
          2. **Potential Issues**: Any bugs, security issues, or best practice violations
          3. **Suggestions**: Improvement recommendations
          4. **Approval**: Whether to approve (âœ…) or request changes (âš ï¸)

          Focus on:
          - Kubernetes/Helm best practices
          - Security concerns (exposed secrets, permissions)
          - Resource naming conventions
          - Configuration errors
          - Missing required fields

          Keep the review concise and actionable.

          {context}
          """

          message = client.messages.create(
              model="claude-sonnet-4-20250514",
              max_tokens=1024,
              messages=[{"role": "user", "content": prompt}]
          )

          review = message.content[0].text

          with open('ai_review.md', 'w') as f:
              f.write(review)

          print("review_available=true")
          EOF

          echo "review_available=true" >> $GITHUB_OUTPUT

      - name: Post Review Comment
        if: steps.claude.outputs.review_available == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let review = '## ðŸ¤– Claude AI Code Review\n\n';
            try {
              review += fs.readFileSync('ai_review.md', 'utf8');
            } catch (e) {
              review += '> AI review skipped - API key not configured\n';
              review += '> To enable AI reviews, add ANTHROPIC_API_KEY to repository secrets.';
            }

            review += '\n\n---\n*Powered by Claude AI*';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });

      - name: Fallback Comment (No API Key)
        if: steps.claude.outputs.review_available != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `## ðŸ¤– AI Code Review

            > âš ï¸ AI review is not configured.
            >
            > To enable Claude AI reviews:
            > 1. Add \`ANTHROPIC_API_KEY\` to repository secrets
            > 2. Re-run this workflow

            **Manual Review Checklist:**
            - [ ] YAML syntax is valid
            - [ ] No hardcoded secrets
            - [ ] Follows naming conventions
            - [ ] Kubernetes resources are properly configured
            - [ ] Changes are documented

            ---
            *Powered by Claude AI*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

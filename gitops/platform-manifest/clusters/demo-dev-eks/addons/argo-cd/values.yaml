global:
  domain: argocd.dev.iexample-org.com
  logging:
    level: error

server:
  replicas: 2
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 50
    targetMemoryUtilizationPercentage: 50
  resources:
    requests:
      cpu: 100m
      memory: 175Mi
    limits:
      memory: 175Mi
  pdb:
    enabled: true
    minAvailable: "1"
  service:
    type: "ClusterIP"
  ingress:
    enabled: true
    https: true
    annotations:
      alb.ingress.kubernetes.io/scheme: "internal"
      alb.ingress.kubernetes.io/target-type: "ip"
      alb.ingress.kubernetes.io/backend-protocol: "HTTPS"
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
      alb.ingress.kubernetes.io/healthcheck-path: /healthz
      alb.ingress.kubernetes.io/healthcheck-protocol: HTTPS
      alb.ingress.kubernetes.io/tags: "Environment=hub,GitOps=true"
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/security-groups: sg-04cba89f30303e9b6
      alb.ingress.kubernetes.io/manage-backend-security-group-rules: "true"
    ingressClassName: "alb"
    hostname: "argocd.dev.iexample-org.com"
    tls: true

controller:
  replicas: 3
  pdb:
    enabled: true
    minAvailable: "1"
  env:
    - name: ARGOCD_CONTROLLER_SHARD # 진정한 sharding: StatefulSet의 pod ordinal 사용
      value: "-1"
    - name: ARGOCD_K8S_CLIENT_QPS # 클라이언트 쿼리 속도 증가
      value: "300"
    - name: ARGOCD_K8S_CLIENT_BURST # 클라이언트 쿼리 버스트 증가
      value: "500"
  resources:
    requests:
      cpu: 265m
      memory: 1017Mi
    limits:
      memory: 1017Mi

applicationSet:
  replicas: 2
  pdb:
    enabled: true
    minAvailable: "1"
  resources:
    requests:
      cpu: 100m
      memory: 100Mi
    limits:
      memory: 100Mi

repoServer:
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 50
    targetMemoryUtilizationPercentage: 50
  env:
    - name: ARGOCD_EXEC_TIMEOUT
      value: "180"
    - name: ARGOCD_GIT_ATTEMPTS_COUNT
      value: "3"
    - name: ARGOCD_HELM_ALLOW_CONCURRENCY
      value: "true"
  resources:
    requests:
      cpu: 161m
      memory: 790Mi
    limits:
      memory: 790Mi

redis:
  resources:
    requests:
      cpu: 100m
      memory: 100Mi
    limits:
      memory: 100Mi

dex:
  resources:
    requests:
      cpu: 100m
      memory: 100Mi
    limits:
      memory: 100Mi

configs:
  cm:
    url: "https://argocd.dev.iexample-org.com"
    resource.exclusions: |
      - apiGroups:
          - autoscaling.k8s.io
        kinds:
          - VerticalPodAutoscalerCheckpoint
          - VerticalPodAutoscaler
        clusters:
          - '*'
      - apiGroups:
          - psmdb.percona.com
        kinds:
          - PerconaServerMongoDBBackup
        clusters:
          - '*'
      - apiGroups:
          - elbv2.k8s.aws
        kinds:
          - TargetGroupBinding
        clusters:
          - '*'
    params:
      server.repo.server.timeout.seconds: "180"
      # 핵심 성능 향상 설정들
      controller.status.processors: "300" # 현재 100 → 300으로 증가
      controller.operation.processors: "150" # 현재 50 → 150으로 증가
      controller.repo.server.timeout.seconds: "180"
      controller.kubectl.parallelism.limit: "50" # 현재 10 → 50으로 증가
      controller.sharding.algorithm: "round-robin"
      reposerver.parallelism.limit: "50" # 현재 10 → 50으로 증가

crds:
  # -- Install and upgrade CRDs
  install: false
  # -- Keep CRDs on chart uninstall
  keep: true
  # -- Annotations to be added to all CRDs
  annotations: {}

notifications:
  resources:
    requests:
      cpu: 100m
      memory: 100Mi
    limits:
      memory: 100Mi
  notifiers:
    service.slack: |
      token: $slack-token
  context:
    argocdUrl: "https://argocd.dev.iexample-org.com"
    title: 데브
    eksClusterName: demo-dev-eks

extraObjects:
  - apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: argo-cd-argocd-server-public
      namespace: argocd
      annotations:
        alb.ingress.kubernetes.io/backend-protocol: HTTPS
        alb.ingress.kubernetes.io/healthcheck-path: /healthz
        alb.ingress.kubernetes.io/healthcheck-protocol: HTTPS
        alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
        alb.ingress.kubernetes.io/manage-backend-security-group-rules: "true"
        alb.ingress.kubernetes.io/security-groups: sg-04cba89f30303e9b6
        alb.ingress.kubernetes.io/ssl-redirect: "443"
        alb.ingress.kubernetes.io/tags: Environment=hub,GitOps=true
        alb.ingress.kubernetes.io/load-balancer-name: argocd-public-dev
        alb.ingress.kubernetes.io/scheme: internet-facing
        alb.ingress.kubernetes.io/target-type: ip
        external-dns.alpha.kubernetes.io/aws-zone-type: public
        external-dns.alpha.kubernetes.io/hostname: argocd-public.dev.iexample-org.com
        external-dns.alpha.kubernetes.io/set-identifier: argocd-public
        external-dns.alpha.kubernetes.io/aws-weight: "100"
        external-dns.alpha.kubernetes.io/ingress-hostname-source: defined-hosts-only
        external-dns-controller: external-dns-public
    spec:
      ingressClassName: alb
      rules:
        - host: argocd-public.dev.iexample-org.com
          http:
            paths:
              - backend:
                  service:
                    name: argo-cd-argocd-server
                    port:
                      number: 443
                path: /api/webhook
                pathType: Prefix
              - backend:
                  service:
                    name: argo-cd-argocd-server
                    port:
                      number: 443
                path: /healthz
                pathType: Prefix

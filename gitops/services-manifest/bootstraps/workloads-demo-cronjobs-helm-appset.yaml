apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: demo-workloads-cronjobs-helm-appset
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=invalid"]
  syncPolicy:
    preserveResourcesOnDeletion: true
  generators:
    - matrix:
        generators:
          - git:
              repoURL: https://github.com/wetripod/demo-gitops-manifest.git
              revision: main
              files:
                - path: configs/**/workloads/demo-crons/*.yaml
          - clusters:
              selector:
                matchLabels:
                  argocd.argoproj.io/secret-type: cluster
                  environment: "{{ index .path.segments 1 }}"
              values:
                chartRepo: https://wetripod.github.io/devops-gitops-manifest
  template:
    metadata:
      name: "example-org-{{ .metadata.labels.aws_cluster_name }}-workload-{{ .application_name }}"
      labels:
        workload: "true"
        app_name: "{{.application_name}}"
      annotations:
        # notifications.argoproj.io/subscribe.on-deploy-start.slack: "{{ .slack_channel }}"
        # notifications.argoproj.io/subscribe.on-deployed.slack: "{{ .slack_channel }}"
        # notifications.argoproj.io/subscribe.on-deployed-failed.slack: "{{ .slack_channel }}"
    spec:
      project: example-org-app-workspaces
      sources:
        - chart: base-cronjobs
          repoURL: "{{ .values.chartRepo }}"
          targetRevision: "{{ .chart.version }}"
          helm:
            releaseName: "{{ .chart.name }}"
            ignoreMissingValueFiles: true
            values: |-
              appName: {{ .application_name }}
              env: {{ .metadata.labels.environment }}
              global:
                deployment:
                  annotations: 
                    ad.datadoghq.com/{{ .application_name }}.logs: |-
                      [{
                        "source": "{{ .source }}",
                        "service": "{{ .application_name }}",
                        "log_processing_rules": [
                          {
                            "type": "exclude_at_match",
                            "name": "exclude_health_check",
                            "pattern" : "health-check"
                          },
                          {
                            "type": "include_at_match",
                            "name": "error_logs",
                            "pattern" : "((?i)ERROR)|LOGGER"
                          }
                        ]
                      }]
            valueFiles:
              - $values/{{ .chart.values }}
        - repoURL: "{{ .repo.helm_values }}"
          targetRevision: '{{ default "main" .branch_name }}'
          ref: values
      destination:
        namespace: demo-cronjobs
        name: "{{ .name }}"
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
          allowEmpty: true
        syncOptions:
          - CreateNamespace=true
          - Validate=false
          - PrunePropagationPolicy=foreground
          - PruneLast=false
          - ApplyOutOfSyncOnly=true
          # - ServerSideApply=true

      ignoreDifferences:
        - group: external-secrets.io
          jqPathExpressions:
            - ".spec.dataFrom[]?.extract.conversionStrategy"
            - ".spec.dataFrom[]?.extract.decodingStrategy"
          kind: ExternalSecret
        - group: autoscaling
          jqPathExpressions:
            - .spec.minReplicas
          kind: HorizontalPodAutoscaler
  templatePatch: |
    metadata:
      annotations:
        argocd-image-updater.argoproj.io/image-list: {{ .application_name }}={{ .repo.ecr }}
        argocd-image-updater.argoproj.io/{{ .application_name }}.pull-secret: secret:argocd/ecr-secret#creds
        argocd-image-updater.argoproj.io/{{ .application_name }}.update-strategy: newest-build
        argocd-image-updater.argoproj.io/{{ .application_name }}.platforms: linux/arm64,linux/amd64
        argocd-image-updater.argoproj.io/write-back-target: helmvalues:{{ .chart.values }}
        argocd-image-updater.argoproj.io/pull-policy: Always
        argocd-image-updater.argoproj.io/write-back-method: git:secret:argocd/git-creds
        argocd-image-updater.argoproj.io/git-repository: {{ .repo.helm_values }}
        argocd-image-updater.argoproj.io/git-branch: {{ default "main" .branch_name }}
        argocd-image-updater.argoproj.io/{{ .application_name }}.allow-tags: regexp:^\d+.*-.*$
        argocd-image-updater.argoproj.io/{{ .application_name }}.force-update: "true"
        argocd-image-updater.argoproj.io/{{ .application_name }}.helm.image-name: cronJobDefault.image.repository
        argocd-image-updater.argoproj.io/{{ .application_name }}.helm.image-tag: cronJobDefault.image.tag
